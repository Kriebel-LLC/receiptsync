name = "receiptsync-worker"
main = "src/worker.ts"
compatibility_date = "2023-08-07"
compatibility_flags = ["nodejs_compat"]
logpush = true
keep_vars = true

[[d1_databases]]
binding = "DB"
database_name = "receiptsync"
database_id = "060717cc-02c9-48de-8033-ee5d33027eb0"
preview_database_id = "DB"

# R2 bucket for storing receipt images and attachments
[[r2_buckets]]
binding = "RECEIPTS_BUCKET"
bucket_name = "receiptsync-receipts"
preview_bucket_name = "receiptsync-receipts-preview"

# ============================================================================
# Staging Environment
# ============================================================================
[env.staging]
workers_dev = true

[[env.staging.d1_databases]]
binding = "DB"
database_name = "receiptsync-staging"
database_id = "060717cc-02c9-48de-8033-ee5d33027eb0"

[[env.staging.r2_buckets]]
binding = "RECEIPTS_BUCKET"
bucket_name = "receiptsync-receipts-staging"

[[env.staging.queues.producers]]
binding = "QUEUE"
queue = "receiptsync-queue-staging"

[[env.staging.queues.consumers]]
queue = "receiptsync-queue-staging"
max_batch_size = 10
max_retries = 3

[env.staging.triggers]
crons = ["0 * * * *"]

# ============================================================================
# Production Environment
# ============================================================================
[env.production]

[[env.production.d1_databases]]
binding = "DB"
database_name = "receiptsync"
database_id = "060717cc-02c9-48de-8033-ee5d33027eb0"

[[env.production.r2_buckets]]
binding = "RECEIPTS_BUCKET"
bucket_name = "receiptsync-receipts"

[[env.production.queues.producers]]
binding = "QUEUE"
queue = "receiptsync-queue"

[[env.production.queues.consumers]]
queue = "receiptsync-queue"
max_batch_size = 10
max_retries = 3

[env.production.triggers]
crons = ["0 * * * *"]

# ============================================================================
# Notes for Setup
# ============================================================================
#
# Email Routing Setup:
# Email routing is configured in the Cloudflare Dashboard, not in wrangler.toml.
# 1. Go to Cloudflare Dashboard > Email > Email Routing
# 2. Add custom address: *@receipts.receiptsync.com (catch-all)
# 3. Set destination to this worker
#
# The email handler will parse the "to" address to extract the org identifier
# (e.g., abc123@receipts.receiptsync.com -> org with addressCode "abc123")
#
# Required R2 buckets to create:
# - receiptsync-receipts (production)
# - receiptsync-receipts-staging (staging)
# - receiptsync-receipts-preview (local dev)
#
# Required Queues to create:
# - receiptsync-queue (production)
# - receiptsync-queue-staging (staging)
